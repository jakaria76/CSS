@model CSS.ViewModels.EventListVM
@{
    ViewData["Title"] = "Events";
}

<link rel="stylesheet" href="~/css/events.css" />

<div class="container my-4">

    <!-- SUCCESS MESSAGE -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- HEADER + CATEGORY FILTER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">Events</h2>

        <div class="d-flex align-items-center gap-2">

            <!-- Category Filter -->
            <select id="categoryFilter" class="form-select d-inline-block w-auto">
                <option value="">All</option>

                @foreach (var c in Model.Categories)
                {
                    <option value="@c" selected="@(c == Model.SelectedCategory)">
                        @c
                    </option>
                }
            </select>

            <!-- Add Event -->
            @if (User.IsInRole("Admin"))
            {
                <a asp-controller="Events" asp-action="Create" class="btn btn-danger ms-2">
                    <i class="fa-solid fa-plus"></i> Add Event
                </a>
            }
        </div>
    </div>


    <!-- FEATURED CAROUSEL -->
    @if (Model.Featured.Any())
    {
        <div id="featuredCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
            <div class="carousel-inner">

                @for (int i = 0; i < Model.Featured.Count; i++)
                {
                    var e = Model.Featured[i];
                    var banner = e.BannerImage != null
                    ? $"data:{e.BannerImageType};base64,{Convert.ToBase64String(e.BannerImage)}"
                    : "/images/default-event.jpg";

                    <div class="carousel-item @(i == 0 ? "active" : "")">
                        <div class="featured-card" style="background-image:url('@banner')">
                            <div class="featured-content">
                                <h3>@e.Title</h3>
                                <p>@e.ShortDescription</p>

                                <a class="btn btn-light" asp-action="Details" asp-route-id="@e.Id">
                                    Details
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <button class="carousel-control-prev" type="button" data-bs-target="#featuredCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>

            <button class="carousel-control-next" type="button" data-bs-target="#featuredCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
    }


    <!-- UPCOMING EVENTS -->
    <h4 class="fw-bold mb-3">Upcoming Events</h4>

    <div class="row">
        @if (!Model.Upcoming.Any())
        {
            <p class="text-muted">No upcoming events.</p>
        }
        else
        {
            @foreach (var e in Model.Upcoming)
            {
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm event-card">

                        @* Banner *@
                        @{
                            var banner = e.BannerImage != null
                            ? $"data:{e.BannerImageType};base64,{Convert.ToBase64String(e.BannerImage)}"
                            : "/images/default-event.jpg";
                        }

                        <img src="@banner" class="card-img-top" style="height:200px;object-fit:cover;" />

                        <div class="card-body">
                            <h5 class="fw-bold">@e.Title</h5>
                            <p class="text-muted">@e.ShortDescription</p>

                            <a asp-action="Details" asp-route-id="@e.Id" class="btn btn-primary btn-sm">Details</a>

                            @* ADMIN ACTION BUTTONS *@
                            @if (User.IsInRole("Admin"))
                            {
                                <a asp-action="Edit" asp-route-id="@e.Id" class="btn btn-warning btn-sm ms-1">
                                    <i class="fa-solid fa-pen"></i>
                                </a>

                                <form asp-action="Delete" asp-route-id="@e.Id" method="post" style="display:inline;">
                                    <button onclick="return confirm('Are you sure to delete this event?')"
                                            class="btn btn-danger btn-sm ms-1">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>


    <!-- PAST EVENTS -->
    <h4 class="fw-bold mt-4 mb-3">Past Events</h4>

    <div class="row">
        @if (!Model.Past.Any())
        {
            <p class="text-muted">No past events found.</p>
        }
        else
        {
            @foreach (var p in Model.Past.Take(8))
            {
                <div class="col-md-3 col-6 mb-3">
                    @{
                        var src = p.BannerImage != null
                        ? $"data:{p.BannerImageType};base64,{Convert.ToBase64String(p.BannerImage)}"
                        : "/images/default-event.jpg";
                    }
                    <img src="@src"
                         class="img-fluid rounded shadow-sm"
                         style="height:140px;object-fit:cover;width:100%" />
                </div>
            }
        }
    </div>

</div>

@section Scripts {
    <script>
        // category filter change
        document.getElementById('categoryFilter').addEventListener('change', function () {
            const v = this.value;
            const url = new URL(window.location.href);

            if (v) url.searchParams.set('category', v);
            else url.searchParams.delete('category');

            window.location.href = url.toString();
        });
    </script>
}
