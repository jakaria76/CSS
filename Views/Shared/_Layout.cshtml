@using Microsoft.AspNetCore.Identity
@using CSS.Models

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - CSS</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>

    <!-- ===== NOTICE BAR ===== -->
    <div class="notice-bar">
        <div class="notice-label">LATEST NOTICE</div>
        <div class="notice-content">
            *** ২০২৪-২০২৫ শিক্ষাবর্ষে ভর্তি হওয়া শিক্ষার্থীদের কাগজপত্র জমা দেওয়ার বিজ্ঞপ্তি ***
        </div>
    </div>

    <!-- ===== HEADER BANNER ===== -->
    <header class="header-banner text-center">
        <div class="container banner-flex">
            <img src="~/images/csslogo.png" class="banner-logo" />
            <div class="banner-text">
                <h2 class="org-title">CONSCIOUS STUDENT SOCIETY</h2>
                <h4 class="org-title-bn">সচেতন ছাত্র সমাজ</h4>
                <p class="org-subtitle">এটি একটি অরাজনৈতিক সংগঠন</p>
            </div>
            <img src="~/images/csslogo.png" class="banner-logo" />
        </div>
    </header>

    <!-- ================= NAVBAR ================= -->
    <nav class="css-navbar">
        <div class="css-navbar-wrapper">

            <ul class="css-nav-list">

                <!-- PUBLIC MENU -->
                @if (!User.Identity?.IsAuthenticated ?? false)
                {
                    <li class="css-item"><a class="css-link" asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="About" asp-action="Index">About</a></li>
                    

                    <li class="css-item"><a class="css-link" asp-controller="Committee" asp-action="Index">Committee</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Blood" asp-action="Index">Blood</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Events" asp-action="Index">Events</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Gallery" asp-action="Index">Gallery</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Home" asp-action="Contact">Contact</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Notice" asp-action="Index">Notice</a></li>
                    <li class="css-item"><a class="css-link login-color" asp-controller="Account" asp-action="Login">Login</a></li>
                }

                <!-- MEMBER MENU -->
                @if (User.Identity?.IsAuthenticated ?? false && !User.IsInRole("Admin"))
                {
                    <li class="css-item"><a class="css-link" asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="About" asp-action="Index">About</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Gallery" asp-action="Index">Gallery</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Help" asp-action="Request">Help</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Events" asp-action="Index">Events</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Profile" asp-action="Index">Profile</a></li>
                    <li class="css-item"><button onclick="confirmLogout()" class="css-link logout-btn">Logout</button></li>
                }

                <!-- ADMIN MENU -->
                @if (User.IsInRole("Admin") && User.IsInRole("User"))
                {
                    <li class="css-item"><a class="css-link" asp-controller="Admin" asp-action="Dashboard">Dashboard</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Gallery" asp-action="Index">Gallery</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="About" asp-action="Index">About</a></li>
                    <li class="css-item">
                        <a class="css-link" asp-controller="AboutManagement" asp-action="Index">
                            About Management
                        </a>
                    </li>

                    <li class="css-item"><a class="css-link" asp-controller="Notice" asp-action="Index">Notice</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="NoticeManagement" asp-action="Index">Notice Management</a></li>

                    <li class="css-item"><a class="css-link" asp-controller="Blood" asp-action="Index">Blood</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Admin" asp-action="Members">Members</a></li>
                    <li class="css-item"><a class="css-link" asp-controller="Admin" asp-action="Welfare">Welfare</a></li>
                    <li class="css-item"><button onclick="confirmLogout()" class="css-link logout-btn">Logout</button></li>
                }

            </ul>

        </div>
    </nav>






    <!-- ============ MAIN CONTENT ============ -->
    <main class="p-0 m-0 w-100">
        @RenderBody()
    </main>

    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2025 - CSS -
            <a asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>


    <!-- ============ TOP GOOGLE MAP (OPTIONAL) ============ -->
    @{
        var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
        var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
    }

    @if (currentController == "Home" && currentAction == "Index")
    {
        <div class="footer-map-wrapper">
            <iframe class="footer-map"
                    loading="lazy"
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"
                    src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d3644.2414600006894!2d89.800917!3d24.069222!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMjTCsDA0JzA5LjIiTiA4OcKwNDgnMDMuMyJF!5e1!3m2!1sen!2sbd!4v1700000000005">
            </iframe>
        </div>
    }


    <!-- ============ PREMIUM FOOTER ============ -->
    <footer class="footer-section">
        <div class="container footer-content pt-3 pb-2">
            <div class="row">

                <div class="col-lg-4 col-md-6 col-12 mb-2">
                    <h5 class="footer-title">CONSCIOUS STUDENT SOCIETY</h5>
                    <ul class="footer-list">
                        <li><i class="fa-solid fa-envelope"></i> consciousstudentsociety@gmail.com</li>
                        <li><i class="fa-solid fa-phone"></i> +880-1700-000000</li>
                        <li><i class="fa-solid fa-location-dot"></i> Chouhali Rajshahi Bangladesh</li>
                    </ul>
                </div>

                <div class="col-lg-4 col-md-6 col-12 mb-2">
                    <h5 class="footer-title">USEFUL LINKS</h5>
                    <ul class="footer-list">
                        <li><i class="fa-solid fa-angle-right"></i> সচেতন ছাত্র সমাজ (CSS)</li>
                    </ul>
                </div>

                <div class="col-lg-4 col-md-12 col-12 mb-2">
                    <h5 class="footer-title">FOLLOW US</h5>

                    <div class="footer-social mb-2">
                        <a href="https://www.facebook.com/organizationofcss"><i class="fa-brands fa-facebook"></i></a>
                        <a href="https://www.youtube.com/channel/UCuLiRjE32T6-Vrnktyu5yuA"><i class="fa-brands fa-youtube"></i></a>
                        <a href="https://www.facebook.com/groups/cssbd2015"><i class="fa-brands fa-facebook"></i></a>
                    </div>

                    <iframe src="https://www.facebook.com/plugins/page.php?href=https://www.facebook.com/edenmohilacollege&tabs=timeline&width=330&height=180&small_header=true&adapt_container_width=true&hide_cover=false&show_facepile=true"
                            width="100%" height="180"
                            style="border:none;overflow:hidden;border-radius:10px;"
                            scrolling="no"
                            frameborder="0"
                            allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
                            allowfullscreen="true">
                    </iframe>
                </div>

            </div>
        </div>

        <div class="footer-bottom text-center py-2">
            © 2025 — CSS. All Rights Reserved.
        </div>
    </footer>

    <style>
        .footer-section {
            background: linear-gradient(to bottom right, #102027, #263238);
            color: #e0e0e0;
            padding-top: 10px;
        }

        .footer-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .footer-list li {
            margin-bottom: 6px;
            font-size: 14px;
            color: #d0d0d0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .footer-list i {
            color: #ff5252;
        }

        .footer-social a {
            margin-right: 10px;
            font-size: 20px;
            color: #ff5252;
            transition: 0.3s;
        }

            .footer-social a:hover {
                color: #ff1744;
                transform: scale(1.1);
            }

        .footer-bottom {
            background: #0d1b22;
            color: #b0bec5;
            font-size: 13px;
            border-top: 1px solid #37474f;
        }
    </style>


    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)


    <!-- Logout Confirmation Popup -->
    <script>
        function confirmLogout() {
            Swal.fire({
                title: 'Are you sure?',
                text: "You will be logged out from your account!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, Logout',
                cancelButtonText: 'Cancel',
                backdrop: `rgba(0,0,0,0.5)`,
            }).then((result) => {
                if (result.isConfirmed) {
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/Account/Logout';

                    const token = document.querySelector('input[name="__RequestVerificationToken"]');
                    if (token) {
                        const cloned = token.cloneNode();
                        cloned.value = token.value;
                        form.appendChild(cloned);
                    }

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }
    </script>


    <!-- ========================= -->
    <!-- ⭐ BOTPRESS WIDGET + WAKE -->
    <!-- ========================= -->
    <!-- 1) Botpress Webchat Script -->
    <script src="https://cdn.botpress.cloud/webchat/v3.4/inject.js"></script>

    <!-- 2) Latest Botpress Config Script (Replace with your LATEST file) -->
    <script src="https://files.bpcontent.cloud/2025/11/30/20/20251130202802-QFLDURDA.js" defer></script>

    <!-- 3) Wake Bot (Free plan sleeping fix) -->
    <script>
        async function wakeBot() {
            try {
                await fetch("https://messaging.botpress.cloud/v1/messages?botId=5eb4089e-2fff-4537-8ca5-5d60ab0c8e49", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        type: "text",
                        text: "_wake_up_",
                        userId: "css-wake-user"
                    })
                });
                console.log("Bot awakened!");
            } catch (e) {
                console.log("Wake error:", e);
            }
        }
        wakeBot();
    </script>

    <!-- 4) Botpress INIT (Default Bubble Enabled) -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            window.botpress.init({
                botId: "5eb4089e-2fff-4537-8ca5-5d60ab0c8e49",
                clientId: "c0f5b2ad-e64e-49b0-9cb9-a375c7c5ce84",

                theme: "light",
                themeColor: "#3276EA",
                disableAnimations: false,
                disableSound: false,

                // DEFAULT BOTPRESS BUBBLE (ON)
                disableLauncher: false,
                hideWidget: false
            });

        });
    </script>


    <script>
        const publicVapidKey = "BOISTyIvgMsU2t69xAWjrU0s4_sywibXjzx_PuqTphpGfkBdPsHaa8A0FZ1xxWyaNnb-Nv2XZD4llgrbe2u0nFI";

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function registerPush() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.log("Push not supported");
                return;
            }

            try {
                const reg = await navigator.serviceWorker.register('/push-sw.js');
                console.log("Service Worker Registered:", reg);

                const permission = await Notification.requestPermission();
                console.log("Notification permission:", permission);
                if (permission !== 'granted') return;

                const subscription = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
                });

                console.log("Subscription:", subscription);

                // send to server
                await fetch('/Profile/SaveSubscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(subscription)
                });

                console.log('Subscribed and sent to server');
            } catch (err) {
                console.error('Push registration failed', err);
            }
        }

        // Run only when user is authenticated
        document.addEventListener('DOMContentLoaded', function () {
            // If your server-side view can detect authentication, render registerPush only for logged-in users
            @if (User.Identity?.IsAuthenticated ?? false)
            {
                    <text>
                    registerPush();
                    </text>
            }
        });
    </script>










</body>
</html>
